---
title: "The five point match"
author: "Lasse Hjorth Madsen"
date: today 
format: 
  html:
    fig-width: 4
    fig-height: 4
toc: true
toc-expand: true
toc-depth: 4
editor: source
execute:
  echo: false
  warning: false
  cache: true
---

```{r setup}
#| cache: false
library(tidyverse)
library(kableExtra)
library(ggrepel)
library(scales)

devtools::load_all(path = "../../bglab")

met <- get_met()
met3 <- round(met, 3)

theme_set(
  theme_minimal() +
  theme(
    axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.grid.major.y = element_blank()
    )
  )
```

```{r helpers}
remove_stuff <- function(text, leading_breaks = 4) {
  text |>
    read_lines() |>
    str_remove("^ {1,6}") |>
    str_remove("Confidence.+") |>
    str_remove("Duration.+") |>
    str_remove("RolloutÂ¹    ") |> 
    str_replace_all("        ", "  ") |> 
    paste(collapse = "\n") |>  
    str_replace_all("\n\n", "\n") |> 
    cat(rep("\n", leading_breaks), ... = _, sep = "")
}

compare_tps <- function(x1, y1, cube1, tps, tpsm) {
  caption <- paste0("Estimated live cube take points at ", x1, "-away, ", y1, "-away, cube at ", cube1)
  
  nice_table <- tps |> 
    filter(x == x1, y == y1, cube == cube1) |> 
    arrange(pos_type) |> 
    left_join(select(tpsm, pos_type, `Take point, money` = tp_real), by = "pos_type") |> 
    select(`Position type` = pos_type, 
           `Take point, match` = tp_real2, 
           `Take point, money`) |> 
    mutate(Difference = `Take point, match` - `Take point, money`) |> 
    kable(format = "html", digits = 3, caption = caption) 
  
  return(nice_table)
}


compare_gvs <- function(x1, y1, cube, met, digits = 2) {
  caption <- paste0("Gammon values at ", x1, "-away, ", y1, "-away")
  
  nice_table <- tibble(`Cube value` = cube) |> rowwise()
  
  if (x1 != y1) {
    nice_table <- nice_table |> 
      mutate(gv1 = gammon_value(x1, y1, `Cube value`, met),
             gv2 = gammon_value(y1, x1, `Cube value`, met)) |>
      rename_with(.fn = ~paste0("Gammon value, ", x1, "-away"), .cols = "gv1") |>
      rename_with(.fn = ~paste0("Gammon value, ", y1, "-away"), .cols = "gv2")
  } else {
    nice_table <- nice_table |> 
      mutate(gv1 = gammon_value(x1, y1, `Cube value`, met)) |> 
      rename_with(.fn = ~paste0("Gammon value, ", x1, "-away"), .cols = "gv1") 
  }
  
  nice_table <- nice_table |> 
    kable(format = "html", digits = digits, caption = caption) 

  return(nice_table) 
}

```

## Why this?

This is walk-through of all scores in a five point match. We examine how take points and cube dynamic varies across scores, with sample positions to illustrate differences.

## Positions types

To show differences due to gammons, we consider five different types of positions:

- Last roll: Truly last roll, not even automatic recubes
- No gammons: Zero gammon but possibly cube leverage
- A little gammon: Early middle games with anchors
- Some gammons: No-anchor middle games
- Many gammons: Blitzes and back games

What do the different gammon situations look like? Below are the examples we will use for examination here, along with money game rollouts.

```{r pos1}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=------A-----------------a-:0:0:1:00:0:0:0:0:10") +
  labs(title = "Position 1: Last roll, marginal money take",
       subtitle = "Black wins 25.0%")

"Player Winning Chances:   75,00% (G:0,00% B:0,00%)
  Opponent Winning Chances: 25,00% (G:0,00% B:0,00%)

Cubeless Equities: No Double=+0,500, Double=+1,000

Cubeful Equities:
       No double:     +0,500 (-0,500)
       Double/Take:   +1,000
       Double/Pass:   +1,000

Best Cube action: Double / Take" |>  
  remove_stuff() |>
  cat()
```

```{r pos2}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-ABBBCB-AA-A-aaaa--bbbbab-:0:0:1:00:0:0:0:0:10") +
  labs(title = "Position 2: No gammons, small money take",
       subtitle = "Black wins 22.1%")

" Player Winning Chances:   77,93% (G:0,00% B:0,00%)
  Opponent Winning Chances: 22,07% (G:0,00% B:0,00%)

Cubeless Equities: No Double=+0,559, Double=+1,117

Cubeful Equities:
       No double:     +0,838 (-0,144)
       Double/Take:   +0,983
       Double/Pass:   +1,000 (+0,017)

Best Cube action: Double / Take" |>  
  remove_stuff() |>
  cat()
```

```{r pos3}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=--b-B-DBB---eC---cBd---a--:0:0:1:00:0:0:0:0:10") +
  labs(title = "Position 3: A little gammon, small money take",
       subtitle = "Black wins 26.4%")

"  Player Winning Chances:   73,58% (G:14,79% B:0,70%)
  Opponent Winning Chances: 26,42% (G:4,53% B:0,16%)

Cubeless Equities: No Double=+0,581, Double=+1,159

Cubeful Equities:
       No double:     +0,923 (-0,052)
       Double/Take:   +0,975
       Double/Pass:   +1,000 (+0,025)

Best Cube action: Double / Take" |>  
  remove_stuff() |>
  cat()
```

```{r pos4}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-aa-B-CBC---cD-b-c-e----A-:0:0:1:00:0:0:0:0:10") +
  labs(title = "Position 4: Some gammons, small money take",
       subtitle = "Black wins 29.2%")

"  Player Winning Chances:   70,79% (G:23,06% B:1,12%)
  Opponent Winning Chances: 29,21% (G:6,10% B:0,23%)

Cubeless Equities: No Double=+0,588, Double=+1,189

Cubeful Equities:
       No double:     +0,871 (-0,101)
       Double/Take:   +0,972
       Double/Pass:   +1,000 (+0,028)

Best Cube action: Double / Take" |>  
  remove_stuff() |>
  cat()
```

```{r pos5}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=b---C-CBB---dC---c-cc-B---:0:0:1:00:0:0:0:0:10") +
  labs(title = "Position 5: Many gammons, small money take",
       subtitle = "Black wins 32.8%")


"  Player Winning Chances:   67,23% (G:35,78% B:0,95%)
  Opponent Winning Chances: 32,77% (G:7,68% B:0,40%)

Cubeless Equities: No Double=+0,616, Double=+1,262

Cubeful Equities:
       No double:     +0,843 (-0,152)
       Double/Take:   +0,995
       Double/Pass:   +1,000 (+0,005)

Best Cube action: Double / Take
" |>  
  remove_stuff() |>  
  cat(sep = "")
```

We'll use these as examples to consider how the score influences take points in a five-point match.

## Overview

First, a high level overview of the scores we see in five-point matches.

### Match equity table

For convenience, here's the default match equity table used by XG, for five-point matches, rounded to three decimal points:


```{r}
met3[1:5, 1:5]
```

### Take point plots

Plotting take points under different situations, might help to build an intuition of the cube dynamics in the five-point match. We first calculate take point assuming the player will never redouble (except for automatic redoubles when we have nothing to lose). This is to see the effect of the score and gammons, for now ignoring the cube.

```{r takepoints}
probs1 <- outcome_probs(c(25.00, 0.00, 0.00, 75.00,  0.00, 0.00)) / 100
probs2 <- outcome_probs(c(22.07, 0.00, 0.00, 77.93,  0.00, 0.00)) / 100
probs3 <- outcome_probs(c(26.42, 4.53, 0.16, 73.58, 14.79, 0.70)) / 100
probs4 <- outcome_probs(c(29.21, 6.10, 0.23, 70.79, 23.06, 1.12)) / 100
probs5 <- outcome_probs(c(32.77, 7.68, 0.40, 67.23, 35.78, 0.95)) / 100

probs <- list(probs1, probs2, probs3, probs4, probs5)
pos_types <- c("Last roll", "Race", "A little gammon", "Some gammons", "Many gammons")

tps <- expand_grid(x = 2:17, y = 2:17, cube = c(1, 2, 4), probs = probs) |>  
  mutate(pos_type = fct(rep(pos_types, 768), levels = pos_types),
         cube_eff = if_else(pos_type == "Last roll", 0, 2/3),
         last_roll = pos_type == "Last roll") |> 
  rowwise() |>  
  mutate(tp_dead  = tp_gammons(x, y, probs, cube, met, last_roll),
         tp_real  = tp_info(x, y, probs, cube, met, cube_eff)["tp_real"],
         tp_live  = tp_xg(x, y, probs, cube, met)["tp_live"],
         tp_real2 = cube_eff * tp_live + (1 - cube_eff) * tp_dead,
         mwc_pass = mwc(x, y - cube, met),
         mwc_take = probs[1] * mwc(x - 2 * cube, y, met) +
                    probs[2] * mwc(x - 4 * cube, y, met) +
                    probs[3] * mwc(x - 6 * cube, y, met) +
                    probs[4] * mwc(x, y - 2 * cube, met) +
                    probs[5] * mwc(x, y - 4 * cube, met) +
                    probs[6] * mwc(x, y - 6 * cube, met),
         emg_pass = emg(mwc_pass, x, y, cube, met),
         emg_take = emg(mwc_take, x, y, cube, met),
         take_marg= emg_take - emg_pass
         ) |>  
  ungroup() |>  
  filter(tp_dead > 0, cube < x) |>  
  mutate(score_label = paste0("-", x, ",-", y)) |>   
  arrange(-tp_dead) 

tpsm <- 
  tibble(probs = probs, 
         pos_type = pos_types,
         eq_roll = c(1.0, 0.983, 0.975, 0.972, 0.995)) |> 
  mutate(cube_eff = if_else(pos_type == "Last roll", 0, 2/3)) |> 
  rowwise() |> 
  mutate(tp_dead = tp_money(probs, cube_eff = 0),
         tp_real = tp_money(probs, cube_eff = cube_eff),
         eq_dead = 2 * eq_money(probs, 1, sum(probs[1:3]), cube_eff = 0),
         eq_real = 2 * eq_money(probs, 1, sum(probs[1:3]))) |> 
  ungroup()
```

```{r plot1}
#| fig-width: 7
#| fig-height: 5
score_order <- tps |> 
  filter(cube == 1, pos_type == "Race") |> 
  arrange(-tp_dead) |> 
  pull(score_label)

money_reflines <- tpsm |> filter(pos_type != "Last roll")

top <- 3

plot_data <- tps |> 
  filter(cube == 1, pos_type != "Last roll") |> 
  select(x, y, cube, pos_type, tp_dead, score_label) |> 
  group_by(pos_type) |> 
  mutate(rank = rank(tp_dead, ties.method = "first")) |> 
  mutate(use_label = 
           ((rank <= top | rank > n() - top) & pos_type == "Race") |
           ((rank <= top | rank > n() - top) & pos_type == "Many gammons" & y > 2),
         label = if_else(use_label, round(tp_dead, 2), NA)) |> 
  ungroup()

plot_data |> 
  ggplot(aes(x = tp_dead, y = score_label, color = pos_type, 
             group = score_label, label = label)) +
  geom_point() +
  geom_line(color = "darkgray") +
  scale_y_discrete(limits = score_order) +
  scale_x_continuous(breaks = seq(0.15, 0.5, 0.05), limits = c(0.15, 0.5)) +
  geom_text_repel(color = "black", size = 3, min.segment.length = 0, 
                  seed = 2, force = 20) +
  geom_vline(data = money_reflines, 
             aes(xintercept = tp_dead, color = pos_type),
             linetype = "dashed", show.legend = F) +
  labs(title = "Initial cube take points across scores and position types",
       subtitle = "-2,-5 is short for 2-away, 5-away. Dashed lines show money game takepoints",
       y = "Score",
       x = "Take point assuming dead cube",
       color = "Position type")
```

Several patterns stand out; some well-know, some might not be so well-know. A few observations:

- The absolutely lowest take point you can face, is when leading 2-away, 5-away in a straight race. You can take here with as little as 17% winning chances.
- Not surprisingly, if you get doubled at 4-away, 2-away, the automatic redouble to 4 also generates a low take point: 19%.
- Leading 2-away, 4-away, get you the third-lowest race take point: 20%.
- However, leading 2-away, *3*-away, makes for a slightly *higher* take point (26%) than for money, since winning two points is also very valuable for the opponent here.
- Same thing at 4-away, 3-away; we have the very highest dead-cube race take point: 35%. (Note that this of course changes when we introduce the cube, since re-cubes are very potent here. But be careful if this is a last-roll situation).
- The innocent 5-away 4-away is also dangerous: Take point 30%.
- At the other end of the spectrum we see (not surprisingly) very high take points when the opponent need 4 *and* has a clear gammon threat. Of course we have the notorious 2-away 4-away, where you need tremendous compensation in terms of winning chances, if you get doubled with a good risk of losing a gammon. But 3-away, 4-away and 5-away, 4-away, are almost as precarious.
- In general, introducing gammons pushed the take points up, a good deal more than for money (compare the purple dots to the purple dotted line), because winning a gammon with the cube at two generally is pretty decisive.  

Let's focus on the effect of introducing the cube. If we look at a straight, medium length race, like in our reference position above, access to the cube in a in a money game generally allows us to take with about 22% rather than the 25% we would need in a true last roll situation.

At match scores, that effect varies considerably. Look at the plot below:


```{r plot2}
#| fig-width: 7
#| fig-height: 5

money_reflines <- tpsm |> 
  filter(pos_type == "Race") |> 
  select(tp_dead, tp_real2 = tp_real) |> 
  pivot_longer(cols = everything())

tps |> 
  filter(cube == 1, pos_type == "Race") |>
  select(score_label, tp_dead, tp_real2) |> 
  pivot_longer(cols = c(tp_dead, tp_real2)) |> 
  arrange(value, desc(name)) |> 
  ggplot(aes(x = value, y = score_label, color = name, group = score_label)) +
  geom_point() +
  geom_line(color = "darkgray") +
  scale_y_discrete(limits = score_order) +
  scale_x_continuous(breaks = seq(0.15, 0.5, 0.05), limits = c(0.15, 0.5)) +
  scale_color_discrete(labels = c("tp_dead" = "Only automatic recubes", 
                                  "tp_real2" = "Semi-efficient recubes")) +
  geom_vline(data = money_reflines, 
            aes(xintercept = value, color = name),
            linetype = "dashed", show.legend = F) +
  labs(title = "Initial cube take points across scores and cube liveliness",
       subtitle = "-2,-5 is short for 2-away, 5-away. Dashed lines show money game takepoints.",
       y = "Score",
       x = "Take point assuming no gammons (e.g. a race)",
       color = "Cube assumption")
```

Of course, at scores where a double/take (and possibly an automatic re-cube) leaves the cube dead, there's no difference between the dead-cube take point and the take point including the cube.

At other scores, in general, the cube benefits the trailer the most: At 4-away, 3-away, for example, cube access makes a massive difference, lowering the take point from 35% to 26%.

In contrast, at 3-away, 5-away, if the leader redoubles, the cube comes back at 8, making his lead meaningless, so being able to redouble is not so helpful. Take point goes from 21% cubeless to 19% with cube leverage. (Both lower than the money take point of 22%, however.) 

## Pre-crawford

### 5-away scores

#### 5-away, 5-away

We give this score a pretty detailed treatment, then apply the same methodology to the rest of the pre-Crawford scores. The intention is to examine the anatomy of all scores: How are they different from money *in general*?

```{r}
compare_tps(x1 = 5, y1 = 5, cube1 = 1, tps = tps, tpsm = tpsm)
```

This table compares take point for the five example positions for money and at the score 5-away, 5-away. When the difference between the match and the money take point is negative, it means the position is easier to take at the match score. When the difference is positive, we have less of a take at the score. 

Let's spot check with a few rollouts at the score: Our sample race position and the blitz position:

```{r pos2-5a5a}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-ABBBCB-AA-A-aaaa--bbbbab-:0:0:1:00:0:0:0:5:10") +
  labs(title = "Example 1: Sample race position",
       subtitle = "Small money take, bigger take at the score")

"Money game, cubeful equities:
       No double:     +0,838 (-0,144)
       Double/Take:   +0,983
       Double/Pass:   +1,000 (+0,017)


5-away, 5-away, cubeful equities:
       No double:     +0,817 (-0,093)
       Double/Take:   +0,910
       Double/Pass:   +1,000 (+0,090)
" |>  
  remove_stuff() |>
  cat()
```

The rollout confirms that this race is indeed a bigger take at the score, as we would expect from the slightly lower take point.

```{r pos5-5a5a}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=b---C-CBB---dC---c-cc-B---:0:0:1:00:0:0:0:5:10") +
  labs(title = "Example 2: Sample position with many gammons",
       subtitle = "Small money take, moderate pass at the score")

"Money game, cubeful equities:
       No double:     +0,843 (-0,152)
       Double/Take:   +0,995
       Double/Pass:   +1,000 (+0,005)


5-away, 5-away, cubeful equities:
       No double:     +0,856 (-0,144)
       Double/Take:   +1,096 (+0,096)
       Double/Pass:   +1,000
" |>  
  remove_stuff() |>  
  cat(sep = "")
```

Again, the rollout shows that the blitz position, which was a marginal take for money, is a pass at the score, due to the slightly higher take point.

Lee's do the rest of the scores, using the same table for displaying take poins and how much they differ for money, but fresh example positions.

#### 4-away, 5-away

```{r}
compare_tps(4, 5, 1, tps, tpsm)
```
Observations

- Winning two points and getting to 2-away is valuable, so take point is lower that for money in last-roll or race positions.

- Losing a gammon hurts extra, so take points rise as the opponents gammon threat rises.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-E--------------------abc-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example 1",
       subtitle = "White wins 23.2%. Pass for money, take at the score")

"Money game, Cubeful Equities:
       No double:     +0,745 (-0,255)
       Double/Take:   +1,064 (+0,064)
       Double/Pass:   +1,000


4-away, 5-away, Cubeful Equities:
       No double:     +0,745 (-0,225)
       Double/Take:   +0,970
       Double/Pass:   +1,000 (+0,030)
" |> remove_stuff() |> cat()
```

This is slightly better that a pure 3-roll position (that yields 21.2% winning chances) because Black is not gin after 22 and 11. Still a moderate pass for money, but a small take at the score.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C---cD---bbd--AbAA:0:0:-1:D:0:0:0:0:10") +
  labs(title = "Example 2",
       subtitle = "Take for money, pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,784 (-0,171)
       Double/Take:   +0,955
       Double/Pass:   +1,000 (+0,045)


4-away, 5-away, Cubeful Equities:
       No double:     +0,801 (-0,199)
       Double/Take:   +1,138 (+0,138)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

Facing a very clear gammon threat, White has a big pass at the score, even though this is a moderate take for money.

#### 3-away, 5-away

```{r}
compare_tps(3, 5, 1, tps, tpsm)
```
Observations

- Winning 2 points is very valuable when 3-away; it gets you to the Crawford game. Therefore, take points in last-roll and race positions are low. 

- Recube vig is low, however, so the difference from money is most pronounced is pure last-roll positions where the cube is dead anyway.

- Gammons are dangerous, so cation is required more and more as the likelihood of losing a gammon increases. 

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-BBBBBB-------------bbccb-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "White wins 19.9%. Clear pass for money, small take at the score")

"
Money game, Cubeful Equities:
       No double:     +0,886 (-0,114)
       Double/Take:   +1,095 (+0,095)
       Double/Pass:   +1,000
       
3-away, 5-away, Cubeful Equities:
       No double:     +0,845 (-0,128)
       Double/Take:   +0,972
       Double/Pass:   +1,000 (+0,028)
" |> remove_stuff() |> cat()
```

Down 7 pips, 42 vs. 35, is a lot, even if Black has more vastage. But a bare take when you need three points to win.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-D---eD---a-cb-b-AA:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Big take for money, clear pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,761 (-0,070)
       Double/Take:   +0,832
       Double/Pass:   +1,000 (+0,168)


3-away, 5-away, Cubeful Equities:
       No double:     +0,895 (-0,105)
       Double/Take:   +1,088 (+0,088)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

Gammons changes the matter. To illustrate, this table of gammon values shows how much doubling *decreases* gammon values for the leader and *increases* gammon values for the trailer, leading to higher take points for the leader whenever gammons are at play.  

```{r}
compare_gvs(3,5,1:2, met)
```

#### 2-away, 5-away

```{r}
compare_tps(2, 5, 1, tps, tpsm)
```

Observations

- Same pattern as in 4-away, 5-away and in 3-away, 5-away, but even more pronounced: White takes more in races, considerable less in gammonish positions. 

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-AAAA----------------aaaa-:0:0:-1:D:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "White wins 17.9% Big pass for money, small take at the score")

"Money game, Cubeful Equities:
       No double:     +0,748 (-0,252)
       Double/Take:   +1,251 (+0,251)
       Double/Pass:   +1,000


2-away, 5-away, Cubeful Equities:
       No double:     +0,689 (-0,283)
       Double/Take:   +0,972
       Double/Pass:   +1,000 (+0,028)
" |> remove_stuff() |> cat()
```
Even in a slightly desperate close-to-last-roll situation White can find a take when two points wins exactly. 

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-BC-cCCA----bBa----bbabb-A:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Scary position - big take for money, big pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,602 (-0,135)
       Double/Take:   +0,736
       Double/Pass:   +1,000 (+0,264)


2-away, 5-away, Cubeful Equities:
       No double:     +0,664 (-0,336)
       Double/Take:   +1,170 (+0,170)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

This is a bit scary since White can easily get closed out and gammoned. Still only 12 rolls cover, and on the remaining 24 rolls White will have plenty of play if he just enters. Even after Blacks 8 rolls with hitting 3's, entering gives counter play. Easy take for money. At 2-away, 5-away it is a big pass, however.

#### 5-away, 4-away

```{r}
compare_tps(5, 4, 1, tps, tpsm)
```

Observations

- As opposed to the reverse score, 4-away, 5-away, the potential two points at stake now benefits the doubling player more, so the trailer faces higher take points *no matter* the type of position.  

- This is because *both* a two-point win and a four-point gammon win is particular valuable to the leader.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=--B--------------------b--:0:0:-1:D:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "White wins 20.1%. Small take for money")

"Money game, Cubeful Equities:
       No double:     +0,475 (-0,475)
       Double/Take:   +0,951
       Double/Pass:   +1,000 (+0,049)


5-away, 4-away, Cubeful Equities:
       No double:     +0,505 (-0,495)
       Double/Take:   +1,110 (+0,110)
       Double/Pass:   +1,000

" |> remove_stuff() |> cat()
```

Standard take for money, even with just $\frac{10}{36}\times\frac{26}{36}\approx 0.201$ winning probability since White has a strong recube on Blacks misses.

At the score recubes are even stronger: Black will need `r tp(4, 5, 2, met) |> round(3)` to take the recube so must pass in case of a miss. That means Whites chances are effectively $\frac{10}{36}\approx 0.278$ -- falling short of the `r tp(5, 4, 1, met, T) |> round(3)` last-roll take point.  `

The two points Black threatens to win are so valuable that White has a clear pass.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-B---AC-B---eE-b-c-e----B-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Clear take, marginal double for money. Small pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,866 (-0,008)
       Double/Take:   +0,874
       Double/Pass:   +1,000 (+0,126)

       
5-away, 4-away, Cubeful Equities:
       No double:     +0,912 (-0,088)
       Double/Take:   +1,058 (+0,058)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

Even this contact position with a position advantage but no particular gammon threat, is a small pass at the score, despite being only a very small double for money. 

#### 5-away, 3-away

```{r}
compare_tps(5, 3, 1, tps, tpsm)
```

Observations

- In a last roll position White still has a high take point, because two points are very valuable for Black -- getting him to the Crawford game

- The race is different, because White now has a lot of cube leverage: Blacks take point when redoubled would be a high `r tp(3,5,2, met) |> round(3)` assuming no gammons. The cube leverage compensates for the high last-roll take point, and leaves White with almost the same take point as for money.

- Like we saw at 3-away, 5-away, the effect of gammons is to *lower* the take point for the trailer. This is because after double/take the gammon value *decreases* for the leader, and *increases* for the trailer.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-B---------------------b--:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "White wins 27.8%. Clear take for money, small pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,444 (-0,444)
       Double/Take:   +0,889
       Double/Pass:   +1,000 (+0,111)


5-away, 3-away, Cubeful Equities:
       No double:     +0,444 (-0,556)
       Double/Take:   +1,038 (+0,038)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

With no recube vig and no gammons, White has a high take point, turning this last-roll position from a clear money take to a small pass.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-BABBBB--AAAA-a-aa-bcbbba-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "White wins 22.1%. Small take for money, small take at the score")

"Money game, Cubeful Equities:
       No double:     +0,840 (-0,143)
       Double/Take:   +0,983
       Double/Pass:   +1,000 (+0,017)


5-away, 3-away, Cubeful Equities:
       No double:     +0,846 (-0,154)
       Double/Take:   +1,000
       Double/Pass:   +1,000 (+0,000)" |> 
  remove_stuff() |> cat()
```
In our sample race position cube action is very similar for money and at the score: Whites extra recube vig offsets the higher take point to begin with.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C-A-eD---aAc--b-bA:0:0:-1:00:0:2:0:5:10") +
  labs(title = "Example position 3",
       subtitle = "Moderate pass for money, huge take, likely no double, at the score")

"Money game, Cubeful Equities:
       No double:     +0,818 (-0,182)
       Double/Take:   +1,062 (+0,062)
       Double/Pass:   +1,000


5-away, 3-away, Cubeful Equities:
       No double:     +0,716
       Double/Take:   +0,699 (-0,017)
       Double/Pass:   +1,000 (+0,284)
       
1296 Games rolled with Variance Reduction.
Moves: 3-ply, cube decisions: XG Roller
" |> remove_stuff() |> cat()
```

Typical blitz position, a pass for money, turns into a big take, mainly because of changes in gammon values. It's not *just* the cube leverage that makes the difference, because as we saw above, a race recube would have a take point for Black not too different from money game.

Gammon values, as we also saw earlier:

```{r}
compare_gvs(5, 3, 1:2, met)
```


#### 5-away, 2-away

```{r}
compare_tps(5, 2, 1, tps, tpsm)
```

Observations

- Without recubes, the trailer's take point is extremely high: a full `r tp(5, 2, 1, met, T) |> round(3)`.

- Of course the one-sided benefit from automatic recube makes a big difference, but, perhaps surprisingly, still leaves the trailer with a slightly higher racing game take point than for money.

- Gammons don't hurt the trailer after a take; naturally this allows for much more liberal takes compared to money game.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-EED-aa--A---------bbbbbc-:0:0:-1:00:0:3:0:5:10") +
  labs(title = "Example position 1",
       subtitle = "Really a last-roll position. White wins 34.2%.")

"Money game, Cubeful Equities:
       No double:     +0,336 (-0,246)
       Double/Take:   +0,582
       Double/Pass:   +1,000 (+0,418)
       
       
5-away, 2-away, Cubeful Equities:
       No double:     +0,348 (-0,652)
       Double/Take:   +1,081 (+0,081)
       Double/Pass:   +1,000" |> 
  remove_stuff() |> cat()
```

If White takes and Black misses, Black will pass the automatic redouble, so that doesn't benefit White much, leaving him with a very high take point and a pass here, even though for money the take is trivial. 

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-B--b-ECB---A---bb-cbbbB--:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Big pass for money, marginal take/pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,965 (-0,035)
       Double/Take:   +1,235 (+0,235)
       Double/Pass:   +1,000
       
       
5-away, 2-away, Cubeful Equities:
       No double:     +0,890 (-0,110)
       Double/Take:   +1,002 (+0,002)
       Double/Pass:   +1,000" |> 
  remove_stuff() |> cat()
```

White wins about 22%, so big pass for money, due to some gammon losses. At 5-away, 2-away after double/take/redouble gammons don't hurt, and White can win four points, Black only two. Intuitively this would lower White's take point by a lot. But the cube is dead which pulls in the opposite direction, and Black's two points are worth a lot. As we saw above, in a straight race White would need `r tp(5, 2, 1, met) |> round(2) |> label_percent()()` to take which is only a bit less than the comparable 25% White would need to take for money with a dead cube.

Bottom line: White has a marginal take/pass decision. 22% is about what he needs, the occasional freak gammon *win* (with a probability about 3%) accounts for the difference from the mentioned `r tp(5, 2, 1, met) |> round(2) |> label_percent()()` racing game dead cube take point.

### 4-away scores

#### 4-away, 4-away

```{r}
compare_tps(4, 4, 1, tps, tpsm)
```

Observations

- Here *all* take points are higher than for money. This is because both a two-point and a four-point win is particular valuable. Doubling, in effect, *more* than doubles the stakes. 

- This also makes future *redoubles* more potent, which is why the smallest difference from money is in straight races: The taker gets powerful recubes but does not need to fear expensive gammon losses.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C---eF---a-c--b-bA:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "Small no double for money, clear double/take at the score")

"Money game, Cubeful Equities:
       No double:     +0,591
       Double/Take:   +0,547 (-0,044)
       Double/Pass:   +1,000 (+0,409)

4-away, 4-away, Cubeful Equities:
       No double:     +0,682 (-0,135)
       Double/Take:   +0,817
       Double/Pass:   +1,000 (+0,183)" |> 
  remove_stuff() |> cat()
```

This is one of the weaker variations on an opening 55 blitz: 65 followed by 55. Not quite a double for money, but a strong double at the score. White has a fine take though; the score calls for caution, not panic.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-ABBABB-aaB-b--B-a-bbbAbb-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Easy take for money, pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,563 (-0,145)
       Double/Take:   +0,707
       Double/Pass:   +1,000 (+0,293)


4-away, 4-away, Cubeful Equities:
       No double:     +0,630 (-0,370)
       Double/Take:   +1,079 (+0,079)
       Double/Pass:   +1,000" |> 
  remove_stuff() |> cat()
```

Highly volatile position, which makes for a good double for money, but clear take. White could get gammoned (about 26% of the time) but also wins 35% of the games. At the score, this is too much, White has a moderate pass.  

#### 3-away, 4-away

```{r}
compare_tps(3, 4, 1, tps, tpsm)
```

Observations

- Here, the two points are more valuable for the leader than the trailer, so the 'raw' take point (cubeless, gammonless) is slightly lower than for money.

- Gammons are dangerous, of course.


```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C---eF---a-c--b-bA:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "Small no double for money, clear pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,591
       Double/Take:   +0,547 (-0,044)
       Double/Pass:   +1,000 (+0,409)


3-away, 4-away, Cubeful Equities:
       No double:     +0,819 (-0,181)
       Double/Take:   +1,139 (+0,139)
       Double/Pass:   +1,000" |> 
  remove_stuff() |> cat()
```

Our 65-55-opening blitz from before (small no double for money), is now a clear pass. The combination of a lethal gammon threat and limited recube potential is just too much. 

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C---cE---cbcb---B-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Clear double/take for money, huge pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,877 (-0,046)
       Double/Take:   +0,923
       Double/Pass:   +1,000 (+0,077)
      

3-away, 4-away, Cubeful Equities:
       No double:     +0,975 (-0,025)
       Double/Take:   +1,436 (+0,436)
       Double/Pass:   +1,000" |> 
  remove_stuff() |> cat()
```

Sound money double in this artificial position, based on big positional advantage (not on volatility). The combinations of gammon threat and low cube value makes this a huge pass at the score.

#### 2-away, 4-away

```{r}
compare_tps(2, 4, 1, tps, tpsm)
```

Observations

- Same pattern as for 4-away, 4-away, and for 3-away, 4-away, but a lot stronger: It's relatively easy to take in no-gammon situations; very hard when a significant gammon threat exists.


```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=--A-B---------------aa-a--:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "White wins 20.9%. Pass for money, take at the score")

"Money game, Cubeful Equities:
       No double:     +0,681 (-0,319)
       Double/Take:   +1,119 (+0,119)
       Double/Pass:   +1,000


2-away, 4-away, Cubeful Equities:
       No double:     +0,656 (-0,298)
       Double/Take:   +0,954
       Double/Pass:   +1,000 (+0,046)
" |> remove_stuff() |> cat()
```

This 21% position is a fine take when we need only 20% to take.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-D---eD---b-d--b-AA:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Nowhere near a double for money, marginal take at the score")

"Money game, Cubeful Equities:
       No double:     +0,405
       Double/Take:   +0,258 (-0,147)
       Double/Pass:   +1,000 (+0,595)


2-away, 4-away, Cubeful Equities:
       No double:     +0,800 (-0,184)
       Double/Take:   +0,984
       Double/Pass:   +1,000 (+0,016)

" |> remove_stuff() |> cat()
```

The slightest smell of blitz, makes for a marginal take at best, at 4-away, 2-away.

#### 4-away, 3-away

```{r}
compare_tps(4, 3, 1, tps, tpsm)
```

Observations

- Even trailing, it's somewhat difficult to find a take at this score -- except when gammons are clearly visible.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-EE--------------------ee-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "White wins 28.1%. Barely a double for money, pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,711 (-0,026)
       Double/Take:   +0,737
       Double/Pass:   +1,000 (+0,263)


4-away, 3-away, Cubeful Equities:
       No double:     +0,918 (-0,082)
       Double/Take:   +1,129 (+0,129)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

A five-roll position is a solid pass at the score.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=----bBD-C---bD--abccb---B-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Small money take, clear take at the score")

"Money game, Cubeful Equities:
       No double:     +0,879 (-0,083)
       Double/Take:   +0,962
       Double/Pass:   +1,000 (+0,038)


4-away, 3-away, Cubeful Equities:
       No double:     +0,839 (-0,049)
       Double/Take:   +0,887
       Double/Pass:   +1,000 (+0,113)
" |> remove_stuff() |> cat()
```

Solid positional advantage, gammons clearly a relevant consideration, so small money take becomes a clear take at 4-away, 3-away.

#### 4-away, 2-away

```{r}
compare_tps(4, 2, 1, tps, tpsm)
```

Observations

- With the perfect automatic recube available the trailer can of course take with `r met3[4,1] |> label_percent()()` -- the winning chance when passing for 4-away, 1-away, Crawford.

- The last-roll situation, where we don't get to the automatic recube, is a trap; here the take point is a very high `r tp(4,2,1,met,T) |> label_percent()()`

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-EEC-b--AA--------bcbbbb--:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "A virtual last roll position.")

"Money game, Cubeful Equities:
       No double:     +0,517 (-0,460)
       Double/Take:   +0,976
       Double/Pass:   +1,000 (+0,024)


4-away, 3-away Cubeful Equities:
       No double:     +0,654 (-0,346)
       Double/Take:   +1,010 (+0,010)
       Double/Pass:   +1,000
" |> remove_stuff() |> cat()
```

If Black misses, 12/36, he will pass the automatic recube, so White really wins 1/3 plus about 3% after getting hit, roughly 35% in total, which is just a bit short of a take. For money, the problem is that White can lose a gammon after getting hit, but he is getting better odds on the take, and so bottomline is a small take.

So a close take/pass decision both at 4-away, 2-away and money, but for different reasons.    

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=----ABCBB----C----bcbcbcB-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Too good to double, yet a take at the score")

"Money game, Cubeful Equities:
       No double:     +1,072
       Double/Take:   +1,847 (+0,775)
       Double/Pass:   +1,000 (-0,072)


4-away, 2-away, Cubeful Equities:
       No double:     +1,062
       Double/Take:   +0,758 (-0,303)
       Double/Pass:   +1,000 (-0,062)" |> 
  remove_stuff() |> cat()
```

Another tricky one: Clearly a gigantic pass for money, moderately too good to double. At the score Black also should play for the gammon which seems quite intuitive. But if doubled, White has a moderate take, because of the low take point. In that sense, the position is both too good and not good enough: If Black doubles he is worse off whether White passes or takes.

### 3-away scores

#### 3-away, 3-away

```{r}
compare_tps(3, 3, 1, tps, tpsm)
```

Observations

- At 3-away, 3-away it is harder to find a take in all position types.
- On one hand, two points are very valuable -- the double more than doubles the stakes -- so in the last-roll starting point the take point is quite a bit higher than for money.
- On the other hand, the cube leverage is a little better than for money, so some of the difference disappears when we allow for redoubles.

- Also note that the gammon value *before* doubling is very high, after double/take the gammon value is similar to money game:

```{r}
compare_gvs(3, 3, 1:2, met)
```


```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-a----E-C-a-cF---caca-b-A-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "Big take for money, moderate pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,802 (-0,082)
       Double/Take:   +0,883
       Double/Pass:   +1,000 (+0,117)


3-away, 3-away, Cubeful Equities:
       No double:     +0,865 (-0,135)
       Double/Take:   +1,052 (+0,052)
       Double/Pass:   +1,000" |> 
  remove_stuff() |> cat()
```

Black leads in every area, except the race, solid double/take for money. But 3-away, 3-away pushes this into double/pass territory.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-----BD-C---dD---dBe--b---:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Moderate take for money, big pass at the score")

"Money game, Cubeful Equities:
       No double:     +0,881 (-0,072)
       Double/Take:   +0,953
       Double/Pass:   +1,000 (+0,047)


3,away,3-away, Cubeful Equities:
       No double:     +0,975 (-0,025)
       Double/Take:   +1,171 (+0,171)
       Double/Pass:   +1,000
       
  1296 Games rolled with Variance Reduction.
  Moves: 3-ply, cube decisions: XG Roller" |> 
  remove_stuff() |> cat()
```
A pretty standard holding game, take for money, becomes a big pass at 3-away, 3-away.

UNote that this is rolled out, instead of using XG++ like elsewhere: Even the truncated rollout in XG++ overestimates holding games.) 


#### 2-away, 3-away

```{r}
compare_tps(2, 3, 1, tps, tpsm)
```

Observations

- Obs.

- Obs.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-E--------------------abc-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "Subtitle")

"

" |> remove_stuff() |> cat()
```

Comment on example 1.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C---cD---bbd--AbAA:0:0:-1:D:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Subtitle")

"

" |> remove_stuff() |> cat()
```

Comment on example 2.

#### 3-away, 2-away

```{r}
compare_tps(3, 2, 1, tps, tpsm)
```

Observations

- Obs.

- Obs.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-E--------------------abc-:0:0:-1:00:0:0:0:0:10") +
  labs(title = "Example position 1",
       subtitle = "Subtitle")

"

" |> remove_stuff() |> cat()
```

Comment on example 1.

```{r}
#| column: page-right
#| layout-ncol: 2

ggboard("XGID=-b----E-C---cD---bbd--AbAA:0:0:-1:D:0:0:0:0:10") +
  labs(title = "Example position 2",
       subtitle = "Subtitle")

"

" |> remove_stuff() |> cat()
```

Comment on example 2.

### The funny two-point match  

## Post-crawford

### 1-away, even-away

### 1-away, odd-away

## Recubes

## The rare 8-cube

## Outside the 5-point match

```{r}
compare_tps(12, 14, 2, tps, tpsm)
```

```{r}
compare_tps(8, 5, 1, tps, tpsm)
```

```{r}
compare_gvs(5, 3, 1:2, met)
```