{
  "hash": "b5db835debbe13f6e40f147998f9f7ac",
  "result": {
    "markdown": "---\ntitle: \"Janowski Formulars\"\nauthor: \"Lasse Hjorth Madsen\"\ndate: today \nformat: html\ntoc: true\ntoc-expand: true\neditor: source\nexecute:\n  echo: false\n  warning: false\n---\n\n::: {.cell}\n\n:::\n\n\n## Why this?\nThis note is for better understanding exactly what eXtreme Gammon does to estimate cubeless and cubeful equities at money and match play. In particular, we apply the Janowski Formular(s) and try to figure out what it means when the eXtreme Gammon Documentation says that \"In eXtreme Gammon the Janowski formula has been extended to apply also in match play\".\n\n## How XG works\nThey basic mechanism is this:\n\n-   A neural net evaluates a position and come up with six probabilities for either winning or losing a regular game, a gammon and a backgammon. (Strictly speaking only five probabilities are estimated; the last outcome is redundant since the probabilities must sum to 1). The estimated probabilities  are for cubeless money game: What will happen if the game is played to conclusion with no doubling cube at money game conditions.\n\n- To improve the quality of this estimate, a weighted average of all possible positions after one and after two rolls is calculated; what we call 2- and 3-ply evaluations. The initial neural net evaluation, 1-ply, is not available in XG.\n\n- From the estimated probability distribtion, it is easy to calculate an expected, or average outcome, the *equity* of the position. This is still assuming money game with no doubling cube. Since that situation *never* happens, the number is not terribly relevant. Therefore, XG tries to estimate what the *cubeful* equity is, using [formulars](https://bkgm.com/articles/Janowski/cubeformulae.pdf) develped by Rick Janowski.\n\n## Janowski formulas\n\nWe won't explain in detail how Rick Janowski's formulars work (that is in the article linked above), we'll just show an example. As mentioned above, game of backgammon played to conclusion can end in six possible ways. \n\nSuppose a position has the follow probablities of each outcome:\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table style='width:60%;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> Regular </th>\n   <th style=\"text-align:right;\"> Gammon </th>\n   <th style=\"text-align:right;\"> Backgammon </th>\n   <th style=\"text-align:right;\"> Sum </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Player wins </td>\n   <td style=\"text-align:right;\"> 0.47 </td>\n   <td style=\"text-align:right;\"> 0.17 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n   <td style=\"text-align:right;\"> 0.65 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Opponent wins </td>\n   <td style=\"text-align:right;\"> 0.31 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n   <td style=\"text-align:right;\"> 0.35 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Sum </td>\n   <td style=\"text-align:right;\"> 0.78 </td>\n   <td style=\"text-align:right;\"> 0.21 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n   <td style=\"text-align:right;\"> 1.00 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nSuppose the relative gammon and backgammon frequencies stay constant as the chance to win changes. Then, the average win will be:\n\n$$W=\\frac{47 \\times 1  + 17 \\times 2 + 1 \\times 3}{47 + 17 + 1} = 1.292\\ points$$\nThe average loss will be:\n\n$$L=\\frac{31 \\times 1  + 4 \\times 2 + 0 \\times 3}{31 + 4 + 0} = 1.114\\ points$$\n\nThe take point, taking recubes into account is:\n\n$$TP= \\frac{L-0.5}{W+L+0.5x}$$\n\nwhere $x$ is what Janowski calls the *cube-life index*  \n\nThe *equity*, as a function of game winning chances, $p$ and cube location (*player*, *center*, *opponent*) is:\n\n\n$$E_{player}= p(W+L+0.5x)-L$$\n$$E_{center}= p(W+L+0.5x)-L-0.5x$$\n$$E_{opponent}= \\frac{4}{4-x}(p(W+L+0.5x)-L-0.25x)$$\n\nFrom these, we can estimate cube actions and the size of any cube errors.\n\nA couple of observations:\n\n  - It shouldn't be too difficult to extend this to match play, since $W$ and $L$ can be calculated with match equities, rather than 1, 2, 3 for regular, gammon and backgammon.\n  \n  - It is a simplification to assume that gammon frequencies remain and cube-life remain constant through a game; near conclusion games are more likely to be races without gammons and fewer opportunities to double efficiently.\n  \nLet's do this with a few practical examples and check if the formulas agree with what XG says.  \n\n## Money game examples\nLet's look at a position after Black opens with 21, slotting:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](janowski_files/figure-html/unnamed-chunk-4-1.png){width=384}\n:::\n:::\n\n\nAccording to XG 2-ply (an average of the value of the position after Black's 21 possible replies), the probabilities of the six possible outcomes of the game, if played to conclusion, are as follows:\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table style='width:60%;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> Regular </th>\n   <th style=\"text-align:right;\"> Gammon </th>\n   <th style=\"text-align:right;\"> Backgammon </th>\n   <th style=\"text-align:right;\"> Sum </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Player wins </td>\n   <td style=\"text-align:right;\"> 0.3574 </td>\n   <td style=\"text-align:right;\"> 0.1319 </td>\n   <td style=\"text-align:right;\"> 0.0091 </td>\n   <td style=\"text-align:right;\"> 0.4984 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Opponent wins </td>\n   <td style=\"text-align:right;\"> 0.3656 </td>\n   <td style=\"text-align:right;\"> 0.1300 </td>\n   <td style=\"text-align:right;\"> 0.0060 </td>\n   <td style=\"text-align:right;\"> 0.5016 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Sum </td>\n   <td style=\"text-align:right;\"> 0.7230 </td>\n   <td style=\"text-align:right;\"> 0.2619 </td>\n   <td style=\"text-align:right;\"> 0.0151 </td>\n   <td style=\"text-align:right;\"> 1.0000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThis comes to a cubeless equity of: $E = 0.0049$; White is a slight underdog to win, but is compensated by a tiny bit of extra gammons and     backgammons, so that the game is basically even. \n\nNote that the numbers that XG reports are probabilities for winning (*including* gammons and backgammons), gammon (*including* backgammon), and backgammon. So they have to be converted to get probabilities that sum to 1. (My R-package, [`backgammon`](https://lassehjorthmadsen.github.io/backgammon/index.html) has a function for that.)\n\nIf we apply Janowski's formulars to the above cubeless probablities, we get:\n\n\n::: {.cell}\n\n:::\n\n\n  - Assuming a *dead* cube, $x=0$, White's take point is: 0.303\n  - Assuming a perfectly *live* cube, $x=1$, White's take point is: 0.2539\n  - Assuming a *dead* cube, $x=0$, Blacks's take point is: 0.31\n  - Assuming a perfectly *live* cube, $x=1$, Black's take point is: 0.2598\n\nAll these numbers align perfectly with what you get when you consult XGs `Analyze|Cube Information` menu.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1808352\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.005264359\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.3443296\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.3030248\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.2539003\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.3100169\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.259759\n```\n:::\n:::\n",
    "supporting": [
      "janowski_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}